#!/bin/bash
# Pre-commit validation hook
# Install: Copy to .git/hooks/pre-commit and chmod +x

set -e

echo "ğŸ” Running pre-commit validation..."

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Exit early if no files staged
if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No staged files to check"
  exit 0
fi

# Color codes for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

ERRORS=0
WARNINGS=0

# ============================================
# 1. Check for secrets and credentials
# ============================================
echo "ğŸ” Checking for secrets..."

SECRET_PATTERNS=(
  "api_key"
  "apikey"
  "api-key"
  "secret"
  "password"
  "passwd"
  "pwd"
  "token"
  "auth_token"
  "access_token"
  "private_key"
  "client_secret"
  "aws_access_key"
  "aws_secret"
  "database_url"
  "db_password"
  "stripe_key"
  "openai_key"
)

for pattern in "${SECRET_PATTERNS[@]}"; do
  # Case-insensitive search in staged changes, excluding .env.example
  if git diff --cached | grep -i "$pattern" | grep -v "\.env\.example" | grep -q "="; then
    echo -e "${RED}âŒ Possible secret detected: '$pattern'${NC}"
    echo "   Staged changes contain '$pattern' assignments"
    echo "   If this is intentional, use git commit --no-verify"
    ERRORS=$((ERRORS + 1))
  fi
done

# ============================================
# 2. Check for .env.local or secret files
# ============================================
echo "ğŸ“ Checking for forbidden files..."

FORBIDDEN_FILES=(
  ".env.local"
  ".env.production"
  "secrets.json"
  "credentials.json"
  "private.key"
  ".aws/credentials"
)

for file in "${FORBIDDEN_FILES[@]}"; do
  if echo "$STAGED_FILES" | grep -q "$file"; then
    echo -e "${RED}âŒ Attempted to commit forbidden file: $file${NC}"
    ERRORS=$((ERRORS + 1))
  fi
done

# ============================================
# 3. Check TypeScript files for 'any' usage
# ============================================
echo "ğŸ“˜ Checking TypeScript for 'any' usage..."

TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

if [ -n "$TS_FILES" ]; then
  for file in $TS_FILES; do
    if git diff --cached "$file" | grep -E '^[+].*:\s*any([^a-zA-Z]|$)' | grep -v '// @ts-any-ok' > /dev/null; then
      echo -e "${YELLOW}âš ï¸  TypeScript 'any' detected in: $file${NC}"
      echo "   Consider using 'unknown' with type guards or specific types"
      echo "   If intentional, add comment: // @ts-any-ok - [reason]"
      WARNINGS=$((WARNINGS + 1))
    fi
  done
fi

# ============================================
# 4. Check for migration files in wrong location
# ============================================
echo "ğŸ—„ï¸  Checking migration file structure..."

MIGRATION_FILES=$(echo "$STAGED_FILES" | grep -i "migration" || true)

if [ -n "$MIGRATION_FILES" ]; then
  for file in $MIGRATION_FILES; do
    # Check if migration is in expected directory
    if ! echo "$file" | grep -qE "(prisma/migrations|db/migrations|database/migrations)"; then
      echo -e "${YELLOW}âš ï¸  Migration file in unexpected location: $file${NC}"
      echo "   Migrations should be in prisma/migrations, db/migrations, or database/migrations"
      WARNINGS=$((WARNINGS + 1))
    fi
    
    # Check if it's modifying an existing migration
    if git diff --cached --name-status | grep "^M" | grep -q "$file"; then
      echo -e "${RED}âŒ Modification of existing migration detected: $file${NC}"
      echo "   Migrations should never be modified. Create a new migration instead."
      ERRORS=$((ERRORS + 1))
    fi
  done
fi

# ============================================
# 5. Check for console.log in production code
# ============================================
echo "ğŸ–¨ï¸  Checking for console.log statements..."

JS_TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(js|jsx|ts|tsx)$' | grep -v -E '(test|spec)\.' || true)

if [ -n "$JS_TS_FILES" ]; then
  for file in $JS_TS_FILES; do
    if git diff --cached "$file" | grep -E '^[+].*console\.(log|debug|info)' | grep -v '// @console-ok' > /dev/null; then
      echo -e "${YELLOW}âš ï¸  console.log found in: $file${NC}"
      echo "   Consider using a proper logging library"
      echo "   If intentional for debugging, add: // @console-ok"
      WARNINGS=$((WARNINGS + 1))
    fi
  done
fi

# ============================================
# 6. Check for TODO/FIXME without context
# ============================================
echo "ğŸ“ Checking for incomplete TODO comments..."

for file in $STAGED_FILES; do
  if git diff --cached "$file" | grep -E '^[+].*\/\/\s*(TODO|FIXME)(\s|:)' | grep -v -E 'TODO \(tech-debt\)|TODO \([a-zA-Z-]+\):' > /dev/null; then
    echo -e "${YELLOW}âš ï¸  Incomplete TODO/FIXME in: $file${NC}"
    echo "   TODOs should include context: // TODO (tech-debt): description"
    echo "   or assign to person: // TODO (username): task"
    WARNINGS=$((WARNINGS + 1))
  fi
done

# ============================================
# 7. Check for large files
# ============================================
echo "ğŸ“¦ Checking file sizes..."

for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    SIZE=$(wc -c < "$file")
    # Warn for files > 1MB (1048576 bytes)
    if [ "$SIZE" -gt 1048576 ]; then
      SIZE_MB=$(echo "scale=2; $SIZE / 1048576" | bc)
      echo -e "${YELLOW}âš ï¸  Large file detected: $file (${SIZE_MB}MB)${NC}"
      echo "   Consider if this file should be committed to git"
      echo "   Large binary files should typically be stored elsewhere"
      WARNINGS=$((WARNINGS + 1))
    fi
  fi
done

# ============================================
# 8. Check package.json for new dependencies
# ============================================
echo "ğŸ“¦ Checking for dependency changes..."

if echo "$STAGED_FILES" | grep -q "package.json"; then
  NEW_DEPS=$(git diff --cached package.json | grep -E '^\+\s*"[^"]+"\s*:' | grep -v '"version"' || true)
  
  if [ -n "$NEW_DEPS" ]; then
    echo -e "${YELLOW}âš ï¸  New dependencies detected in package.json${NC}"
    echo "$NEW_DEPS"
    echo "   Verify these dependencies are:"
    echo "   - Actively maintained (commits in last 3 months)"
    echo "   - Security-scanned (Snyk score >7)"
    echo "   - Not duplicating existing functionality"
    echo "   - Approved by team lead"
    WARNINGS=$((WARNINGS + 1))
    
    read -p "   Continue with commit? [y/N] " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
      exit 1
    fi
  fi
fi

# ============================================
# 9. Check for direct database queries without indexes
# ============================================
echo "ğŸ” Checking for potentially slow database queries..."

for file in $STAGED_FILES; do
  if git diff --cached "$file" | grep -E '^[+].*(findMany|findFirst).*where' | grep -v 'take:\s*[0-9]' > /dev/null; then
    echo -e "${YELLOW}âš ï¸  Database query without LIMIT in: $file${NC}"
    echo "   Consider adding take/limit to prevent unbounded queries"
    WARNINGS=$((WARNINGS + 1))
  fi
done

# ============================================
# Summary and Exit
# ============================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ $ERRORS -gt 0 ]; then
  echo -e "${RED}âŒ Pre-commit validation FAILED${NC}"
  echo -e "${RED}   Errors: $ERRORS${NC}"
  echo -e "${YELLOW}   Warnings: $WARNINGS${NC}"
  echo ""
  echo "Fix the errors above or use --no-verify to skip (not recommended)"
  exit 1
fi

if [ $WARNINGS -gt 0 ]; then
  echo -e "${YELLOW}âš ï¸  Pre-commit validation passed with warnings${NC}"
  echo -e "${YELLOW}   Warnings: $WARNINGS${NC}"
  echo ""
  read -p "Continue with commit? [Y/n] " -n 1 -r
  echo
  if [[ $REPLY =~ ^[Nn]$ ]]; then
    exit 1
  fi
fi

echo -e "${GREEN}âœ… Pre-commit validation passed${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
exit 0
